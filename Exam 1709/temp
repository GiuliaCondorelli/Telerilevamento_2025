# 📦 1. Pacchetti necessari
library(terra)
library(sf)
library(ggplot2)

# 📍 2. Carica area di interesse
aoi <- st_read("gran_sasso_area.shp")

# 🛰️ 3. Carica le bande Sentinel-2 (scaricate da GEE o ESA)
# NDVI = (B8 - B4) / (B8 + B4)

# 2015
b4_2015 <- rast("S2_2015_B4.tif")  # Red
b8_2015 <- rast("S2_2015_B8.tif")  # NIR

# 2020
b4_2020 <- rast("S2_2020_B4.tif")
b8_2020 <- rast("S2_2020_B8.tif")

# 🧮 4. Calcola NDVI
ndvi_2015 <- (b8_2015 - b4_2015) / (b8_2015 + b4_2015)
ndvi_2020 <- (b8_2020 - b4_2020) / (b8_2020 + b4_2020)

# ✂️ 5. Ritaglia e maschera sull’area di studio
ndvi_2015_crop <- mask(crop(ndvi_2015, aoi), aoi)
ndvi_2020_crop <- mask(crop(ndvi_2020, aoi), aoi)

# 🔁 6. Calcola differenza NDVI
ndvi_diff <- ndvi_2020_crop - ndvi_2015_crop

# 📈 7. Statistiche semplici
mean_2015 <- global(ndvi_2015_crop, "mean", na.rm = TRUE)
mean_2020 <- global(ndvi_2020_crop, "mean", na.rm = TRUE)
mean_diff <- global(ndvi_diff, "mean", na.rm = TRUE)

print(paste("NDVI medio 2015:", round(mean_2015, 3)))
print(paste("NDVI medio 2020:", round(mean_2020, 3)))
print(paste("Differenza media NDVI:", round(mean_diff, 3)))

# 🗺️ 8. Visualizza i risultati
plot(ndvi_2015_crop, main = "NDVI 2015", col = terrain.colors(20))
plot(ndvi_2020_crop, main = "NDVI 2020", col = terrain.colors(20))
plot(ndvi_diff, main = "Differenza NDVI (2020 - 2015)", col = rev(terrain.colors(20)))



Per usare ggplot2 con un raster, prima bisogna convertirlo in data.frame.

Ecco la versione ggplot completa per visualizzare NDVI 2015, 2020 e la differenza:

library(ggplot2)
library(terra)
library(sf)

# Converti raster in data.frame per ggplot
ndvi_df <- function(r) {
  df <- as.data.frame(r, xy = TRUE)
  colnames(df)[3] <- "NDVI"
  return(df)
}

ndvi_2015_df <- ndvi_df(ndvi_2015_mask)
ndvi_2020_df <- ndvi_df(ndvi_2020_mask)
ndvi_diff_df <- ndvi_df(ndvi_diff)

# Palette colori NDVI
ndvi_colors <- scale_fill_gradientn(
  colours = c("brown", "yellow", "green"),
  limits = c(-1, 1),
  name = "NDVI"
)

# NDVI 2015
ggplot(ndvi_2015_df, aes(x = x, y = y, fill = NDVI)) +
  geom_raster() +
  coord_equal() +
  ndvi_colors +
  ggtitle("NDVI 2015 - Gran Sasso") +
  theme_minimal()

# NDVI 2020
ggplot(ndvi_2020_df, aes(x = x, y = y, fill = NDVI)) +
  geom_raster() +
  coord_equal() +
  ndvi_colors +
  ggtitle("NDVI 2020 - Gran Sasso") +
  theme_minimal()

# Differenza
ggplot(ndvi_diff_df, aes(x = x, y = y, fill = NDVI)) +
  geom_raster() +
  coord_equal() +
  scale_fill_gradient2(low = "red", mid = "white", high = "darkgreen", midpoint = 0,
                       name = "ΔNDVI") +
  ggtitle("Differenza NDVI (2020 - 2015)") +
  theme_minimal()



